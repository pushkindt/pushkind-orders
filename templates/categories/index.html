{% extends 'base.html' %}

{% block styles %}
    {{ super() }}
    <style>
        .category-tree-toggle .icon-open {
            display: none;
        }

        .category-tree-toggle[aria-expanded="true"] .icon-open {
            display: inline-flex;
        }

        .category-tree-toggle[aria-expanded="true"] .icon-closed {
            display: none;
        }

        .category-archived {
            opacity: 0.6;
        }
    </style>
{% endblock %}

{% macro node(n) %}

    <div class="mb-2">
        <div class="d-flex align-items-center bg-white p-2 rounded-3 shadow-sm{% if n.category.is_archived %} category-archived{% endif %}">
            <div class="d-flex align-items-center flex-grow-1">
                {% if n.children | length > 0 %}
                    <button
                        class="btn btn-sm btn-link p-0 text-secondary category-tree-toggle"
                        type="button"
                        data-bs-toggle="collapse"
                        data-bs-target="#collapseChildren{{ n.category.id }}"
                        aria-expanded="false"
                        aria-controls="collapseChildren{{ n.category.id }}"
                    >
                        <i class="bi bi-chevron-right icon-closed" aria-hidden="true"></i>
                        <i class="bi bi-chevron-down icon-open" aria-hidden="true"></i>
                        <span class="visually-hidden">Toggle subcategories</span>
                    </button>
                {% endif %}
                <div class="ms-2">
                    <p class="fw-semibold mb-0 d-flex align-items-center gap-2">
                        {{ n.category.name }}
                        {% if n.category.is_archived %}
                            <span class="badge text-bg-warning-subtle text-warning-emphasis border-0">Архивирована</span>
                        {% endif %}
                    </p>
                    <p class="small text-muted mb-0">
                        {{ n.category.description | default(value='') }}
                    </p>
                </div>
            </div>
            <div class="d-flex align-items-center ms-auto">
                <button class="btn btn-sm btn-outline-success border-0 p-1"
                        data-bs-toggle="modal"
                        data-bs-target="#addCategoryModal"
                        data-parent-id="{{n.category.id}}"
                        data-parent-name="{{n.category.name}}"
                >
                    <i class="bi bi-plus-lg"></i>
                </button>
                <button class="btn btn-sm btn-outline-primary border-0 p-1 ms-1"
                        title="Edit category"
                        title="Add child category"
                        data-bs-toggle="modal"
                        data-bs-target="#editCategoryModal"
                        data-category-id="{{ n.category.id }}"
                        data-category-name="{{ n.category.name }}"
                        data-category-description="{{ n.category.description | default(value='') }}"
                        data-category-archived="{{ n.category.is_archived }}"
                >
                    <i class="bi bi-pencil-square"></i>
                </button>
            </div>
        </div>
    </div>

    {% if n.children | length > 0 %}
        <div class="ps-4 transition-all max-h-screen opacity-100 collapse" id="collapseChildren{{ n.category.id }}">
            <div class="mt-2">
                {% for c in n.children %}
                    {{ self::node(n=c) }}
                {% endfor %}
            </div>
        </div>
    {% endif %}
{% endmacro %}

{% macro forest(nodes) %}
    {% for n in nodes %}
        {{ self::node(n=n) }}
    {% endfor %}
{% endmacro %}

{% block content %}
{% include 'components/navigation.html' %}





<div class="container bg-white border rounded my-2">
    <div class="row mb-3">
        <div class="col text-center add-item-container">
            <button class="btn btn-link" type="button" data-bs-toggle="modal" data-bs-target="#addCategoryModal">
                <i class="bi bi-plus-circle"></i>
            </button>
        </div>
    </div>
    {{ self::forest(nodes=category_tree) }}
</div>

{% include 'categories/add_category_modal.html' %}
{% include 'categories/edit_category_modal.html' %}

{% endblock %}
{% block scripts %}{% endblock %}
