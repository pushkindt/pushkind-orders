{% extends 'base.html' %}

{% block styles %}
    {{ super() }}
    <style>
        .price-level-default {
            border-left: 4px solid var(--bs-success);
            background-color: rgba(var(--bs-success-rgb), 0.08);
        }
    </style>
{% endblock %}

{% block content %}
{% include 'components/navigation.html' %}

<div class="container bg-white border rounded my-2">

    <div class="row">
        <div class="col text-center add-item-container">
            <button class="btn btn-link" type="button" data-bs-toggle="modal" data-bs-target="#priceModal">
                <i class="bi bi-plus-circle"></i>
            </button>
        </div>
    </div>

    {% include 'price_levels/price_level_list.html' %}
</div>

<div class="container bg-white border rounded my-2">
    <div class="row">
        <div class="col">
            <h2 class="h5 my-3">Клиенты</h2>
            <div id="clientsStatusMessage" class="alert alert-info" role="status">
                Загрузка списка клиентов...
            </div>
            <div class="table-responsive">
                <table class="table table-striped table-hover align-middle mb-0">
                    <thead>
                        <tr>
                            <th scope="col">Название</th>
                            <th scope="col">Email</th>
                            <th scope="col">Телефон</th>
                            <th scope="col">Уровень</th>
                        </tr>
                    </thead>
                    <tbody id="clientsTableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

{% include 'price_levels/add_price_modal.html' %}
{% include 'price_levels/edit_price_modal.html' %}

{% endblock %}

{% block scripts %}
    {{ super() }}
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const clientsTableBody = document.getElementById('clientsTableBody');
            const statusMessage = document.getElementById('clientsStatusMessage');

            if (!clientsTableBody || !statusMessage) {
                return;
            }

            function setStatus(message, type = 'info') {
                statusMessage.textContent = message;
                statusMessage.className = `alert alert-${type}`;
                statusMessage.hidden = false;
            }

            function hideStatus() {
                statusMessage.hidden = true;
            }

            fetch('{{crm_service_url | safe}}/api/v1/clients', {credentials: 'include'})
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Ошибка загрузки: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    const clients = Array.isArray(data) ? data : [];

                    if (clients.length === 0) {
                        setStatus('Клиенты не найдены.', 'warning');
                        return;
                    }

                    const fragment = document.createDocumentFragment();

                    clients.forEach(client => {
                        const row = document.createElement('tr');

                        const nameCell = document.createElement('td');
                        nameCell.textContent = client.name ?? '';
                        row.appendChild(nameCell);

                        const emailCell = document.createElement('td');
                        emailCell.textContent = client.email ?? '—';
                        row.appendChild(emailCell);

                        const phoneCell = document.createElement('td');
                        phoneCell.textContent = client.phone ?? '—';
                        row.appendChild(phoneCell);

                        const hubCell = document.createElement('td');
                        hubCell.textContent = '{{ price_levels.items | map(attribute="name") | first | default(value="") }}';
                        row.appendChild(hubCell);

                        fragment.appendChild(row);
                    });

                    clientsTableBody.replaceChildren(fragment);
                    hideStatus();
                })
                .catch(error => {
                    console.error('Не удалось загрузить клиентов:', error);
                    setStatus('Не удалось загрузить клиентов. Попробуйте обновить страницу позже.', 'danger');
                });
        });
    </script>
{% endblock %}
