{% extends 'base.html' %}

{% block styles %}
    {{ super() }}
    <style>
        .price-level-default {
            border-left: 4px solid var(--bs-success);
            background-color: rgba(var(--bs-success-rgb), 0.08);
        }
    </style>
{% endblock %}

{% block content %}
{% include 'components/navigation.html' %}

<div class="container bg-white border rounded my-2">

    <div class="row">
        <div class="col text-center add-item-container">
            <button class="btn btn-link" type="button" data-bs-toggle="modal" data-bs-target="#priceModal">
                <i class="bi bi-plus-circle"></i>
            </button>
        </div>
    </div>

    {% include 'price_levels/price_level_list.html' %}
</div>

<div class="container bg-white border rounded my-2">
    <div class="row">
        <div class="col">
            <h2 class="h5 my-3">Клиенты</h2>
            <div id="clientsStatusMessage" class="alert alert-info" role="status">
                Загрузка списка клиентов...
            </div>
            <div class="table-responsive">
                <table class="table table-striped table-hover align-middle mb-0">
                    <thead>
                        <tr>
                            <th scope="col">Название</th>
                            <th scope="col">Email</th>
                            <th scope="col">Телефон</th>
                            <th scope="col">Уровень</th>
                        </tr>
                    </thead>
                    <tbody id="clientsTableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

{% include 'price_levels/add_price_modal.html' %}
{% include 'price_levels/edit_price_modal.html' %}

{% endblock %}

{% block scripts %}
    {{ super() }}
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const clientsTableBody = document.getElementById('clientsTableBody');
            const statusMessage = document.getElementById('clientsStatusMessage');
            const priceLevels = {{ price_levels | json_encode() | safe }};
            const priceLevelById = new Map(priceLevels.map(level => [level.id, level]));
            const defaultLevelFromList = priceLevels.find(level => level.is_default) ?? null;

            if (!clientsTableBody || !statusMessage) {
                return;
            }

            function setStatus(message, type = 'info') {
                statusMessage.textContent = message;
                statusMessage.className = `alert alert-${type}`;
                statusMessage.hidden = false;
            }

            function hideStatus() {
                statusMessage.hidden = true;
            }

            function normalizeEmail(value) {
                return typeof value === 'string' ? value.trim().toLowerCase() : '';
            }

            function normalizePhone(value) {
                if (typeof value !== 'string') {
                    return '';
                }
                return value.trim();
            }

            function normalizeName(value) {
                if (typeof value !== 'string') {
                    return '';
                }
                return value.replace(/\s+/g, ' ').trim();
            }

            function buildContactKey(email, phone) {
                return `${normalizeEmail(email)}::${normalizePhone(phone ?? '')}`;
            }

            function fetchClients() {
                return fetch('{{crm_service_url | safe}}/api/v1/clients', {credentials: 'include'})
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`CRM_${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => (Array.isArray(data) ? data : []));
            }

            function fetchAssignments() {
                return fetch('/api/v1/client-price-levels', {credentials: 'include'})
                    .then(response => {
                        if (response.status === 401) {
                            throw new Error('UNAUTHORIZED');
                        }
                        if (!response.ok) {
                            throw new Error(`API_${response.status}`);
                        }
                        return response.json();
                    });
            }

            function createPriceLevelSelect(contact, savedId, fallbackId) {
                const select = document.createElement('select');
                select.className = 'form-select form-select-sm';

                const contactValid = Number.isInteger(contact.hubId)
                    && contact.name.length > 0
                    && typeof contact.email === 'string'
                    && contact.email.length > 0;

                if (!contactValid) {
                    select.disabled = true;
                    select.title = 'Недостаточно данных для назначения уровня.';
                }

                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                if (defaultLevelFromList) {
                    defaultOption.textContent = `По умолчанию — ${defaultLevelFromList.name}`;
                } else if (fallbackId && priceLevelById.has(fallbackId)) {
                    defaultOption.textContent = `По умолчанию — ${priceLevelById.get(fallbackId).name}`;
                } else {
                    defaultOption.textContent = 'По умолчанию';
                }
                select.appendChild(defaultOption);

                priceLevels.forEach(level => {
                    const option = document.createElement('option');
                    option.value = String(level.id);
                    option.textContent = level.name;
                    select.appendChild(option);
                });

                const normalizedValue = savedId == null ? '' : String(savedId);
                select.value = normalizedValue;
                select.dataset.currentValue = normalizedValue;

                select.addEventListener('change', () => {
                    const previousValue = select.dataset.currentValue ?? '';
                    const rawValue = select.value;
                    const parsedValue = rawValue === '' ? null : Number.parseInt(rawValue, 10);

                    if (rawValue !== '' && !Number.isInteger(parsedValue)) {
                        select.value = previousValue;
                        return;
                    }

                    if (!contactValid) {
                        select.value = previousValue;
                        setStatus('Недостаточно данных для сохранения уровня клиента.', 'danger');
                        return;
                    }

                    select.disabled = true;
                    setStatus('Сохранение...', 'info');

                    fetch('/api/v1/client-price-levels', {
                        method: 'PUT',
                        credentials: 'include',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            hub_id: contact.hubId,
                            name: contact.name,
                            email: contact.email,
                            phone: contact.phone ?? null,
                            price_level_id: parsedValue,
                        }),
                    })
                        .then(response => {
                            if (response.status === 401) {
                                throw new Error('UNAUTHORIZED');
                            }
                            if (response.status === 404) {
                                throw new Error('NOT_FOUND');
                            }
                            if (response.status === 422) {
                                return response.json().then(data => {
                                    const message = typeof data?.error === 'string'
                                        ? data.error
                                        : 'Неверный уровень цен.';
                                    throw new Error(`FORM:${message}`);
                                });
                            }
                            if (!response.ok) {
                                throw new Error(`API_${response.status}`);
                            }

                            select.dataset.currentValue = rawValue;
                            setStatus('Уровень сохранен.', 'success');
                            window.setTimeout(() => hideStatus(), 3000);
                        })
                        .catch(error => {
                            console.error(
                                'Не удалось сохранить уровень клиента:',
                                contact.email,
                                contact.phone ?? null,
                                error,
                            );
                            select.value = previousValue;

                            let message = 'Не удалось сохранить уровень клиента. Попробуйте позже.';
                            if (error.message === 'UNAUTHORIZED') {
                                message = 'Недостаточно прав для сохранения уровня клиента.';
                            } else if (error.message === 'NOT_FOUND') {
                                message = 'Клиент не найден или недоступен.';
                            } else if (error.message.startsWith('FORM:')) {
                                message = error.message.substring(5);
                            }

                            setStatus(message, 'danger');
                        })
                        .finally(() => {
                            if (contactValid) {
                                select.disabled = false;
                            }
                        });
                });

                return select;
            }

            Promise.all([fetchClients(), fetchAssignments()])
                .then(([clients, assignmentData]) => {
                    const assignments = Array.isArray(assignmentData?.assignments)
                        ? assignmentData.assignments
                        : [];
                    const assignmentLookup = new Map(
                        assignments
                            .filter(item => item && typeof item.email === 'string')
                            .map(item => [
                                buildContactKey(item.email, item.phone ?? ''),
                                item.price_level_id ?? null,
                            ]),
                    );

                    const hubIdFromAssignments = Number.isInteger(assignmentData?.hub_id)
                        ? assignmentData.hub_id
                        : null;
                    const fallbackHubId = Number.isInteger(priceLevels[0]?.hub_id)
                        ? priceLevels[0].hub_id
                        : null;
                    const hubId = hubIdFromAssignments ?? fallbackHubId;

                    const defaultAssignmentId = typeof assignmentData?.default_price_level_id === 'number'
                        ? assignmentData.default_price_level_id
                        : (defaultLevelFromList?.id ?? (priceLevels[0]?.id ?? null));

                    if (!Array.isArray(clients) || clients.length === 0) {
                        setStatus('Клиенты не найдены.', 'warning');
                        clientsTableBody.replaceChildren();
                        return;
                    }

                    if (!Number.isInteger(hubId)) {
                        setStatus('Не удалось определить хаб для сохранения уровней.', 'warning');
                    }

                    const fragment = document.createDocumentFragment();

                    clients.forEach(client => {
                        const row = document.createElement('tr');

                        const nameCell = document.createElement('td');
                        nameCell.textContent = client.name ?? '';
                        row.appendChild(nameCell);

                        const emailCell = document.createElement('td');
                        emailCell.textContent = client.email ?? '—';
                        row.appendChild(emailCell);

                        const phoneCell = document.createElement('td');
                        phoneCell.textContent = client.phone ?? '—';
                        row.appendChild(phoneCell);

                        const hubCell = document.createElement('td');
                        const savedId = assignmentLookup.get(
                            buildContactKey(client.email, client.phone ?? ''),
                        ) ?? null;
                        const normalizedEmail = normalizeEmail(client.email);
                        const normalizedPhone = normalizePhone(client.phone);
                        const contact = {
                            hubId,
                            name: normalizeName(client.name),
                            email: normalizedEmail,
                            phone: normalizedPhone === '' ? null : normalizedPhone,
                        };
                        const select = createPriceLevelSelect(contact, savedId, defaultAssignmentId);
                        hubCell.appendChild(select);
                        row.appendChild(hubCell);

                        fragment.appendChild(row);
                    });

                    clientsTableBody.replaceChildren(fragment);
                    if (Number.isInteger(hubId)) {
                        hideStatus();
                    }
                })
                .catch(error => {
                    console.error('Не удалось загрузить данные клиентов или уровней:', error);
                    setStatus('Не удалось загрузить клиентов. Попробуйте обновить страницу позже.', 'danger');
                });
        });
    </script>
{% endblock %}
