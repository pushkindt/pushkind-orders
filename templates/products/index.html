{% extends 'base.html' %}

{% block styles %}
<style>
    .add-product-container {
        display: flex;
        align-items: center;
        text-align: center;
    }

    .add-product-container>button:hover {
        opacity: 0.5;
    }

    .add-product-container>button {
        opacity: 1.0;
    }

    .add-product-container>button:active {
        opacity: 1.0;
    }

    .add-product-container::before,
    .add-product-container::after {
        content: '';
        flex: 1;
        border-bottom: 1px solid #000;
        margin: 0 10px;
    }

    .product-recent {
        background-color: rgba(255, 243, 205, 0.6);
    }
</style>
{% endblock %}

{% block content %}
{% include 'components/navigation.html' %}

<div class="container bg-white border rounded my-2">

    <div class="row">
        <div class="col text-center add-product-container">
            <button class="btn btn-link" type="button" data-bs-toggle="modal" data-bs-target="#productModal">
                <i class="bi bi-plus-circle"></i>
            </button>
        </div>
        <div class="col-auto">
            <button class="btn btn-sm btn-outline-secondary d-flex align-items-center gap-2 mt-1" type="button"
                data-bs-toggle="modal" data-bs-target="#filtersModal">
                <i class="bi bi-funnel"></i>
                <span id="activeFiltersBadge" class="badge text-bg-primary {% if status_filter or updated_after or updated_before %}{% else %}d-none{% endif %}">•</span>
            </button>
        </div>
    </div>

    <div class="row d-none d-sm-flex fw-bold">
        <div class="col-sm-2 overflow-hidden">Идентификатор</div>
        <div class="col-sm overflow-hidden">Название</div>
        <div class="col-sm overflow-hidden">Описание</div>
        <div class="col-sm-2 overflow-hidden">Статус</div>
    </div>
    <div id="productList">
        {% for product in products.items %}
        <div class="row my-1 py-1 border-top selectable {% if product.id in recently_updated_product_ids %}product-recent{% endif %}" data-id="{{ product.id }}">
            <div class="col-sm-2">
                <strong>{{ product.id }}</strong>
                <div class="text-muted small">
                    <i class="bi bi-clock-history" aria-hidden="true"></i> {{ product.updated_at | date(format="%Y-%m-%d %H:%M") }}
                </div>
            </div>
            <div class="col-sm">
                <span class="d-sm-none fw-bold">Название:</span>
                {{ product.title }}
            </div>
            <div class="col-sm">
                <span class="d-sm-none fw-bold">Описание:</span>
                {{ macros::product_description(description=product.description) }}
            </div>
            <div class="col-sm-2">
                <span class="d-sm-none fw-bold">Статус:</span>
                {{ macros::product_status(value=product.status) }}
            </div>
        </div>
        {% else %}
        <div class="alert alert-warning my-2" role="alert">
            Нет задач для отображения.
        </div>
        {% endfor %}
    </div>

    {{ macros::pagination(
        pages=products.pages,
        current_page=products.page,
        search=search | default(value=""),
        status=status_filter | default(value=""),
        updated_after=updated_after | default(value=""),
        updated_before=updated_before | default(value="")
    ) }}
</div>

<div class="modal fade" id="filtersModal" tabindex="-1" aria-labelledby="filtersModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="filtersModalLabel">Фильтры задач</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
            </div>
            <form id="filtersForm" class="modal-body row g-3" method="get" action="/">
                {% set status_value = status_filter | default(value="") %}
                {% set updated_after_value = updated_after | default(value="") %}
                {% set updated_before_value = updated_before | default(value="") %}
                {% if search %}
                <input type="hidden" name="search" value="{{ search }}">
                {% endif %}
                <div class="col-12">
                    <label for="filterStatus" class="form-label small text-uppercase text-muted mb-1">Статус</label>
                    <select id="filterStatus" name="status" class="form-select">
                        <option value=""{% if status_value == "" %} selected{% endif %}>Все</option>
                        <option value="Pending"{% if status_value == "Pending" %} selected{% endif %}>В ожидании</option>
                        <option value="InProgress"{% if status_value == "InProgress" %} selected{% endif %}>В работе</option>
                        <option value="Blocked"{% if status_value == "Blocked" %} selected{% endif %}>Заблокирована</option>
                        <option value="Completed"{% if status_value == "Completed" %} selected{% endif %}>Завершена</option>
                        <option value="Archived"{% if status_value == "Archived" %} selected{% endif %}>Архивирована</option>
                    </select>
                </div>
                <div class="col-12 col-md-6">
                    <label for="filterUpdatedAfter" class="form-label small text-uppercase text-muted mb-1">Обновлена после</label>
                    <input id="filterUpdatedAfter" name="updated_after" type="date" class="form-control" value="{{ updated_after_value }}">
                </div>
                <div class="col-12 col-md-6">
                    <label for="filterUpdatedBefore" class="form-label small text-uppercase text-muted mb-1">Обновлена до</label>
                    <input id="filterUpdatedBefore" name="updated_before" type="date" class="form-control" value="{{ updated_before_value }}">
                </div>
                <div class="col-12 d-flex flex-wrap gap-2 justify-content-end pt-3">
                    <button type="submit" class="btn btn-primary">Применить</button>
                    <a href="/" class="btn btn-outline-secondary">Сбросить</a>
                </div>
            </form>
        </div>
    </div>
</div>

{% include 'products/add_product_modal.html' %}

{% endblock %}


{% block scripts %}
<script>
    document.addEventListener("DOMContentLoaded", () => {
        var selectableList = document.querySelectorAll(".selectable");
        selectableList.forEach((selectable) => {
            selectable.addEventListener("click", () => {
                const productId = selectable.dataset.id;
                document.location.href = `/product/${productId}`;
            });
        });

        const params = new URLSearchParams(window.location.search);
        const status = params.get("status") || "";
        const updatedAfter = params.get("updated_after") || "";
        const updatedBefore = params.get("updated_before") || "";

        const statusField = document.getElementById("filterStatus");
        const updatedAfterField = document.getElementById("filterUpdatedAfter");
        const updatedBeforeField = document.getElementById("filterUpdatedBefore");
        if (statusField) {
            statusField.value = status;
        }
        if (updatedAfterField) {
            updatedAfterField.value = updatedAfter;
        }
        if (updatedBeforeField) {
            updatedBeforeField.value = updatedBefore;
        }

        const hasActiveFilters = Boolean(
            status || updatedAfter || updatedBefore
        );
        const badge = document.getElementById("activeFiltersBadge");
        if (badge && hasActiveFilters) {
            badge.classList.remove("d-none");
        }
    });
</script>
{% endblock %}
